<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Envíos UADE - Gestión Total</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4e54c8; --secondary: #8f94fb; }
        body { background: linear-gradient(to right, #4e54c8, #8f94fb); min-height: 100vh; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); margin-bottom: 20px; }
        .card-header { background: transparent; border-bottom: 2px solid #f0f0f0; padding: 20px; font-weight: bold; color: var(--primary); }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 600; }
        .status-pendiente { background-color: #eee; color: #333; }
        .status-despachado { background-color: #d1ecf1; color: #0c5460; }
        .status-encamino { background-color: #fff3cd; color: #856404; }
        .status-entregado { background-color: #d4edda; color: #155724; }
        .status-cancelado { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center text-white mb-5">
            <h1><i class="fas fa-boxes"></i> Gestión de Envíos</h1>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="glass-card">
                    <div class="card-header"><i class="fas fa-plus"></i> Nuevo Envío</div>
                    <div class="card-body p-4">
                        <form onsubmit="crearEnvio(event)">
                            <div class="mb-3"><label>Cliente</label><input type="text" class="form-control" id="cliente" required></div>
                            <div class="mb-3"><label>Dirección</label><input type="text" class="form-control" id="direccion" required></div>
                            <div class="mb-3">
                                <label>Provincia</label>
                                <select class="form-select" id="provincia" required>
                                    <option value="" selected disabled>Seleccione una provincia...</option>
                                    <option value="Buenos Aires">Buenos Aires</option>
                                    <option value="CABA">CABA</option>
                                    <option value="Catamarca">Catamarca</option>
                                    <option value="Chaco">Chaco</option>
                                    <option value="Chubut">Chubut</option>
                                    <option value="Cordoba">Córdoba</option>
                                    <option value="Corrientes">Corrientes</option>
                                    <option value="Entre Rios">Entre Ríos</option>
                                    <option value="Formosa">Formosa</option>
                                    <option value="Jujuy">Jujuy</option>
                                    <option value="La Pampa">La Pampa</option>
                                    <option value="La Rioja">La Rioja</option>
                                    <option value="Mendoza">Mendoza</option>
                                    <option value="Misiones">Misiones</option>
                                    <option value="Neuquen">Neuquén</option>
                                    <option value="Rio Negro">Río Negro</option>
                                    <option value="Salta">Salta</option>
                                    <option value="San Juan">San Juan</option>
                                    <option value="San Luis">San Luis</option>
                                    <option value="Santa Cruz">Santa Cruz</option>
                                    <option value="Santa Fe">Santa Fe</option>
                                    <option value="Santiago Del Estero">Santiago del Estero</option>
                                    <option value="Tierra Del Fuego">Tierra del Fuego</option>
                                    <option value="Tucuman">Tucumán</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Registrar Envío</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="glass-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list"></i> Lista de Envíos</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="cargarPedidos()">Actualizar</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Cliente/Destino</th>
                                    <th>Estado Actual</th>
                                    <th>Cambiar Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPedidos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ""; 

        document.addEventListener('DOMContentLoaded', cargarPedidos);

        async function cargarPedidos() {
            try {
                const res = await fetch(`${API_URL}/pedidos`);
                const data = await res.json();
                const tbody = document.getElementById('tablaPedidos');
                tbody.innerHTML = '';

                data.pedidos.forEach(p => {
                    const statusClass = `status-${p.estado.toLowerCase().replace(/\s/g, '')}`;
                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold">${p.codigo}</td>
                            <td><small>${p.cliente}</small><br>${p.direccion}, ${p.provincia}</td>
                            <td><span class="status-badge ${statusClass}">${p.estado}</span></td>
                            <td>
                                <select class="form-select form-select-sm" onchange="cambiarEstado('${p.codigo}', this.value)">
                                    <option value="" selected disabled>Acción...</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Despachado">Despachado</option>
                                    <option value="En Camino">En Camino</option>
                                    <option value="Entregado">Entregado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error cargando pedidos:", error);
            }
        }

        async function cambiarEstado(codigo, nuevoEstado) {
            try {
                const res = await fetch(`${API_URL}/pedidos/cambiar_estado`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ codigo: codigo, nuevo_estado: nuevoEstado })
                });
                
                const data = await res.json();
                
                if (!res.ok || !data.exito) {
                    // AQUÍ ESTÁ LA CLAVE: Mostramos el error que viene del Backend (Python)
                    alert("⚠️ " + (data.detail || data.mensaje));
                    cargarPedidos(); // Recargamos para deshacer el cambio visual erróneo
                } else {
                    cargarPedidos(); // Si salió bien, recargamos la tabla
                }
            } catch (e) {
                alert("Error de conexión con el servidor");
            }
        }

        async function crearEnvio(e) {
            e.preventDefault();
            const datos = {
                nombre_cliente: document.getElementById('cliente').value,
                direccion: document.getElementById('direccion').value,
                provincia: document.getElementById('provincia').value
            };
            
            try {
                const res = await fetch(`${API_URL}/pedidos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const data = await res.json();

                if (!res.ok || !data.exito) {
                    // Si el backend rechaza (ej: provincia inválida), mostramos el mensaje
                    alert("❌ Error: " + (data.detail || data.mensaje));
                } else {
                    e.target.reset();
                    cargarPedidos();
                }
            } catch (e) {
                alert("Error al crear el envío");
            }
        }
    </script>
</body>
</html>
